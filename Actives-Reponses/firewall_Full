#!/bin/bash

LOG_FILE="/var/log/wazuh/firewall_Full.log"
STATE_FILE="/var/ossec/active-response/bin/firewall_state.json"
WHITELIST="/var/ossec/active-response/bin/whitelist.txt"

ACTION=$1
read INPUT_JSON

# Extraction robuste de l'alerte
ALERT=$(echo "$INPUT_JSON" | jq -r '.parameters.alert // .alert // empty')

# Debug: log brut
echo "$(date '+%F %T') ðŸ” JSON brut reÃ§u: $INPUT_JSON" >> "$LOG_FILE"

# Extraction de lâ€™IP
IP=$(echo "$ALERT" | jq -r '.data.srcip // .srcip // empty')

# VÃ©rification IP valide
if [ -z "$IP" ] || [ "$IP" == "null" ]; then
    echo "$(date '+%F %T') âŒ IP invalide ou non prÃ©sente, sortie. DonnÃ©e reÃ§ue: $INPUT_JSON" >> "$LOG_FILE"
    exit 1
fi

# Whitelist
if grep -qFx "$IP" "$WHITELIST"; then
    echo "$(date '+%F %T') ðŸ›¡ï¸ IP $IP dans whitelist, ignorÃ©e." >> "$LOG_FILE"
    exit 0
fi

# Init Ã©tat
[ ! -f "$STATE_FILE" ] && echo '{}' > "$STATE_FILE"

# IncrÃ©ment
COUNT=$(jq -r --arg ip "$IP" '.[$ip].count // 0' "$STATE_FILE")
NEW_COUNT=$((COUNT + 1))

# DurÃ©e par palier
case $NEW_COUNT in
    1) DURATION=30 ;;
    2) DURATION=300 ;;
    3) DURATION=3600 ;;
    *) DURATION=0 ;;
esac

# Sauvegarde Ã©tat
jq --arg ip "$IP" --argjson count "$NEW_COUNT" \
   '.[$ip].count = $count | .[$ip].last_seen = (now | todate)' \
   "$STATE_FILE" > tmp.$$.json && mv tmp.$$.json "$STATE_FILE"

# Traitement des actions
case "$ACTION" in
  add)
    iptables -I INPUT -s "$IP" -j DROP
    if [ "$DURATION" -eq 0 ]; then
      echo "$(date '+%F %T') â›” IP $IP bloquÃ©e dÃ©finitivement (tentatives: $NEW_COUNT)." >> "$LOG_FILE"
    else
      echo "$(date '+%F %T') â›” IP $IP bloquÃ©e pour $DURATION secondes (tentatives: $NEW_COUNT)." >> "$LOG_FILE"
      (sleep "$DURATION"; iptables -D INPUT -s "$IP" -j DROP && \
       echo "$(date '+%F %T') âœ… IP $IP dÃ©bloquÃ©e aprÃ¨s $DURATION secondes." >> "$LOG_FILE") &
    fi
    ;;
  delete)
    iptables -D INPUT -s "$IP" -j DROP
    echo "$(date '+%F %T') ðŸ—‘ï¸ IP $IP dÃ©bloquÃ©e manuellement." >> "$LOG_FILE"
    ;;
  *)
    echo "$(date '+%F %T') âš ï¸ Action inconnue ($ACTION), sortie." >> "$LOG_FILE"
    exit 1
    ;;
esac

exit 0
